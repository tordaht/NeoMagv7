<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🧬 NeoMag V7 - Profesyonel Bio-Fizik Laboratuvarı</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script> {/* Güncellenmiş Plotly CDN bağlantısı */}
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #3b82f6; /* Daha canlı bir mavi */
            --secondary: #10b981; /* Yeşilimsi bir ikincil renk */
            --accent: #f59e0b; /* Vurgu için kehribar */
            --success: #22c55e; /* Başarı için canlı yeşil */
            --warning: #eab308; /* Uyarı için sarı */
            --error: #ef4444; /* Hata için canlı kırmızı */
            --bg1: #111827; /* Koyu gri-mavi */
            --bg2: #1f2937; /* Orta koyu gri-mavi */
            --bg3: #374151; /* Açık gri-mavi */
            --bg4: #4b5563; /* Daha açık gri-mavi */
            --text1: #f3f4f6; /* Çok açık gri */
            --text2: #d1d5db; /* Açık gri */
            --text3: #9ca3af; /* Orta gri */
            --border: #4b5563; /* Kenarlık için bg4 ile aynı */
            --elite: #ffd700; --veteran: #4169e1; --strong: #32cd32;
            --energetic: #ff6347; --young: #00bfff; --basic: #ff8c00;
            --glass: rgba(31, 41, 55, 0.7); /* Daha opak cam efekti */
            --glass-border: rgba(75, 85, 99, 0.5); /* Daha belirgin cam kenarlığı */
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            background: linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 50%, var(--primary) 120%);
            color: var(--text1); min-height: 100vh; overflow-x: hidden;
            line-height: 1.6;
        }

        .app-container {
            display: grid;
            grid-template-areas: "header header"
                                 "sidebar main";
            grid-template-rows: 70px 1fr;
            grid-template-columns: 320px 1fr; /* Kenar çubuğu biraz daha geniş */
            min-height: 100vh; gap: 16px; padding: 16px;
        }

        .header {
            grid-area: header;
            background: var(--glass);
            backdrop-filter: blur(15px) saturate(180%);
            border: 1px solid var(--glass-border);
            border-radius: 12px; display: flex; justify-content: space-between;
            align-items: center; padding: 0 28px; box-shadow: 0 8px 32px rgba(0,0,0,0.37);
        }

        .logo { font-size: 26px; font-weight: 700; color: var(--text1); letter-spacing: -0.5px; }
        .status-bar { display: flex; gap: 16px; align-items: center; }
        .status-pill {
            padding: 8px 14px; border-radius: 20px; font-size: 12px; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .status-running { background-color: var(--success); color: white; }
        .status-paused { background-color: var(--warning); color: var(--bg1); }
        .status-stopped { background-color: var(--error); color: white; }

        .sidebar {
            grid-area: sidebar;
            background: var(--glass);
            backdrop-filter: blur(15px) saturate(180%);
            border: 1px solid var(--glass-border);
            border-radius: 12px; padding: 24px; overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.37);
        }
        .sidebar::-webkit-scrollbar { width: 6px; }
        .sidebar::-webkit-scrollbar-thumb { background-color: var(--accent); border-radius: 3px; }
        .sidebar::-webkit-scrollbar-track { background-color: transparent; }


        .main-area {
            grid-area: main; display: grid;
            grid-template-areas: "simulation stats"
                                 "charts charts";
            grid-template-rows: minmax(400px, 60vh) auto; /* Simülasyon alanı daha esnek */
            grid-template-columns: 1fr 380px; /* İstatistik paneli biraz daha geniş */
            gap: 16px;
        }

        .panel { /* Genel panel stili */
            background: var(--glass);
            backdrop-filter: blur(15px) saturate(180%);
            border: 1px solid var(--glass-border);
            border-radius: 12px; padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.37);
        }

        .simulation-panel { grid-area: simulation; position: relative; overflow: hidden; }
        .stats-panel { grid-area: stats; overflow-y: auto; }
        .charts-grid-container { /* charts-grid için bir sarmalayıcı */
            grid-area: charts;
            overflow-y: auto; /* Sadece bu sarmalayıcıda dikey kaydırma */
            padding-right: 8px; /* Kaydırma çubuğu için boşluk */
        }

        .charts-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Daha duyarlı */
            gap: 16px;
            /* max-height kaldırıldı, sarmalayıcı yönetecek */
        }
        .charts-grid-container::-webkit-scrollbar { width: 6px; }
        .charts-grid-container::-webkit-scrollbar-thumb { background-color: var(--accent); border-radius: 3px; }


        .section { margin-bottom: 28px; }
        .section-title { 
            font-size: 16px; font-weight: 600; color: var(--accent);
            margin-bottom: 16px; text-transform: uppercase; letter-spacing: 0.8px;
            border-bottom: 1px solid var(--border); padding-bottom: 8px;
        }

        .btn {
            width: 100%; padding: 12px 16px; margin-bottom: 10px; border: none; border-radius: 8px;
            background: linear-gradient(145deg, var(--primary), var(--secondary));
            color: white; font-weight: 600; cursor: pointer; transition: all 0.25s ease-out;
            font-size: 13px; text-transform: uppercase; letter-spacing: 0.7px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .btn:hover { 
            transform: translateY(-3px) scale(1.02); 
            box-shadow: 0 10px 25px rgba(var(--rgb-secondary, 16, 185, 129), 0.4); /* --secondary'nin RGB karşılığı */
        }
         .btn:active { transform: translateY(-1px); }
        .btn-danger { background: linear-gradient(145deg, var(--error), #c53030); }
        .btn-warning { background: linear-gradient(145deg, var(--warning), #dd6b20); }
        .btn:disabled { background: var(--bg3); color: var(--text3); cursor: not-allowed; box-shadow: none; transform: none;}


        .input-group { margin-bottom: 16px; }
        .input-group label { 
            display: block; margin-bottom: 6px; color: var(--text2); 
            font-size: 12px; font-weight: 500;
        }
        .input-group input { 
            width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 6px;
            background: var(--bg2); color: var(--text1); font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-group input:focus {
            outline: none; border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(var(--rgb-accent, 245, 158, 11), 0.3); /* --accent'in RGB karşılığı */
        }


        .canvas {
            width: 100%; height: 100%; 
            background-image: 
                radial-gradient(circle at 15% 25%, rgba(var(--rgb-primary, 59, 130, 246), 0.15), transparent 50%),
                radial-gradient(circle at 85% 75%, rgba(var(--rgb-accent, 245, 158, 11), 0.1), transparent 50%),
                linear-gradient(160deg, var(--bg1) 0%, var(--bg2) 100%);
            border-radius: 10px; position: relative; overflow: hidden; cursor: grab;
            border: 1px solid var(--glass-border);
        }
        .canvas:active { cursor: grabbing; }


        .bacterium {
            position: absolute; border-radius: 50%; transition: all 0.2s ease-out;
            cursor: pointer; 
            border: 2px solid rgba(255,255,255,0.3);
            box-shadow: 0 0 12px rgba(0,0,0,0.5), inset 0 0 5px rgba(255,255,255,0.2);
        }
        .bacterium:hover { 
            transform: scale(1.25); 
            box-shadow: 0 0 25px rgba(var(--rgb-accent, 245, 158, 11), 0.7), inset 0 0 8px rgba(255,255,255,0.3);
            z-index: 10; border-color: var(--accent);
        }
        /* Sınıf renkleri için RGB değerlerini de tanımlayalım */
        :root {
            --rgb-primary: 59, 130, 246; --rgb-secondary: 16, 185, 129; --rgb-accent: 245, 158, 11;
            --rgb-elite: 255, 215, 0; --rgb-veteran: 65, 105, 225; --rgb-strong: 50, 205, 50;
            --rgb-energetic: 255, 99, 71; --rgb-young: 0, 191, 255; --rgb-basic: 255, 140, 0;
        }

        .bacterium.elite { background: radial-gradient(circle, rgba(var(--rgb-elite),1), rgba(var(--rgb-elite),0.7)); }
        .bacterium.veteran { background: radial-gradient(circle, rgba(var(--rgb-veteran),1), rgba(var(--rgb-veteran),0.7)); }
        .bacterium.strong { background: radial-gradient(circle, rgba(var(--rgb-strong),1), rgba(var(--rgb-strong),0.7)); }
        .bacterium.energetic { background: radial-gradient(circle, rgba(var(--rgb-energetic),1), rgba(var(--rgb-energetic),0.7)); }
        .bacterium.young { background: radial-gradient(circle, rgba(var(--rgb-young),1), rgba(var(--rgb-young),0.7)); }
        .bacterium.basic { background: radial-gradient(circle, rgba(var(--rgb-basic),1), rgba(var(--rgb-basic),0.7)); }


        .food { 
            position: absolute; width: 6px; height: 6px; 
            background: radial-gradient(circle, #34d399, #059669); 
            border-radius: 50%; box-shadow: 0 0 10px #34d399, 0 0 20px #34d399;
            animation: pulse 1.8s infinite ease-in-out;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(0.9); opacity: 0.8; }
            50% { transform: scale(1.15); opacity: 1; }
        }

        .stat-card {
            background: linear-gradient(145deg, var(--bg3), var(--bg2));
            border: 1px solid var(--glass-border);
            border-radius: 10px; padding: 16px; margin-bottom: 10px; text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .stat-card:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,0.25); }

        .stat-value { 
            font-size: 22px; font-weight: 700; color: var(--secondary);
            margin-bottom: 4px;
        }
        .stat-label { 
            font-size: 11px; color: var(--text3); text-transform: uppercase; 
            letter-spacing: 0.7px;
        }

        .chart-container {
            background: linear-gradient(145deg, var(--bg3), var(--bg2));
            border: 1px solid var(--glass-border);
            border-radius: 10px; padding: 16px; min-height: 200px; /* Grafiklere daha fazla yer */
            display: flex; flex-direction: column;
            transition: transform 0.2s, box-shadow 0.2s;
        }
         .chart-container:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,0.25); }

        .chart-title {
            font-size: 13px; font-weight: 600; color: var(--accent);
            margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.6px;
            text-align: center;
        }
        .plotly-chart-div { flex-grow: 1; } /* Plotly div'inin kalan alanı doldurmasını sağlar */


        .modal {
            display: none; position: fixed; z-index: 2000; left: 0; top: 0; 
            width: 100%; height: 100%; background: rgba(17, 24, 39, 0.85); /* bg1'e yakın bir renk */
            backdrop-filter: blur(8px) saturate(150%);
            align-items: center; justify-content: center; /* İçeriği ortalamak için */
        }
        .modal-content {
            background: linear-gradient(145deg, var(--bg2), var(--bg3));
            padding: 28px; border-radius: 16px; width: 90%; max-width: 650px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 20px 50px rgba(0,0,0,0.4);
            position: relative; /* Kapatma butonu için */
        }
        .close { 
            position: absolute; top: 16px; right: 20px;
            color: var(--text3); font-size: 32px; font-weight: bold; 
            cursor: pointer; transition: color 0.2s, transform 0.2s;
        }
        .close:hover { color: var(--text1); transform: scale(1.1); }


        .class-legend {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-top: 16px;
        }
        .legend-item {
            display: flex; align-items: center; gap: 8px; padding: 6px 10px;
            background: rgba(var(--rgb-text1, 243, 244, 246), 0.08); border-radius: 6px; font-size: 11px;
        }
        .legend-dot { width: 10px; height: 10px; border-radius: 50%; }

        .keyboard-shortcuts {
            position: fixed; bottom: 16px; right: 16px; padding: 14px;
            background: var(--glass); backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border); border-radius: 8px;
            font-size: 11px; color: var(--text2);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 1000;
        }
        .keyboard-shortcuts strong { color: var(--accent); }

        .loading { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: var(--text2); font-size: 16px; font-weight: 500;
            display: flex; flex-direction: column; align-items: center; gap: 8px;
        }
        .loading::before { /* Basit bir yükleme animasyonu */
            content: ''; display: block; width: 24px; height: 24px;
            border-radius: 50%; border: 3px solid var(--text3);
            border-top-color: var(--accent);
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }


        .connection-status {
            padding: 6px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;
        }
        .connected { background-color: var(--success); color: white; }
        .disconnected { background-color: var(--error); color: white; }

        /* Mobil cihazlar için düzenlemeler */
        @media (max-width: 1024px) {
            .app-container {
                grid-template-areas: "header" "sidebar" "main";
                grid-template-rows: 70px auto 1fr;
                grid-template-columns: 1fr;
            }
            .sidebar { max-height: 40vh; overflow-y: auto; }
            .main-area {
                grid-template-areas: "simulation" "stats" "charts";
                grid-template-rows: 400px auto auto;
                grid-template-columns: 1fr;
            }
            .stats-panel { max-height: 30vh; }
        }
         @media (max-width: 768px) {
            .charts-grid { grid-template-columns: 1fr; } /* Grafikleri tek sütun yap */
            .logo { font-size: 20px; }
            .status-pill { padding: 6px 10px; font-size: 10px;}
            .btn { padding: 10px 14px; font-size: 12px;}
         }

    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="logo">🧬 NeoMag V7 Laboratuvarı</div>
            <div class="status-bar">
                <div id="connectionStatus" class="connection-status disconnected">BAĞLANTI...</div>
                <div id="simulationStatus" class="status-pill status-stopped">DURDU</div>
                <div class="status-pill">FPS: <span id="fpsDisplay">--</span></div>
                <div class="status-pill">ADIM: <span id="stepDisplay">0</span></div>
            </div>
        </header>

        <!-- Sidebar Controls -->
        <aside class="sidebar panel">
            <div class="section">
                <h2 class="section-title">Simülasyon Kontrolü</h2>
                <button id="startBtn" class="btn">🚀 Başlat</button>
                <button id="pauseBtn" class="btn btn-warning" disabled>⏸️ Duraklat</button>
                <button id="stopBtn" class="btn btn-danger" disabled>⏹️ Durdur</button>
            </div>

            <div class="section">
                <h2 class="section-title">🦠 Parametreler</h2>
                <div class="input-group">
                    <label for="bacteriaCount">Başlangıç Bakteri Sayısı</label>
                    <input type="number" id="bacteriaCount" value="30" min="5" max="150">
                </div>
                <button id="addBacteriaBtn" class="btn" disabled>➕ 10 Bakteri Ekle</button>
            </div>

            <div class="section">
                <h2 class="section-title">📈 Veri İşlemleri</h2>
                <button id="exportBtn" class="btn">💾 Veri Dışa Aktar</button>
                <!-- <button id="resetDataBtn" class="btn btn-warning">🔄 Verileri Sıfırla</button> -->
            </div>

            <div class="section">
                <h2 class="section-title">🎨 Bakteri Sınıfları</h2>
                <div class="class-legend">
                    <div class="legend-item"><div class="legend-dot" style="background:var(--elite)"></div>Elite</div>
                    <div class="legend-item"><div class="legend-dot" style="background:var(--veteran)"></div>Veteran</div>
                    <div class="legend-item"><div class="legend-dot" style="background:var(--strong)"></div>Güçlü</div>
                    <div class="legend-item"><div class="legend-dot" style="background:var(--energetic)"></div>Enerjik</div>
                    <div class="legend-item"><div class="legend-dot" style="background:var(--young)"></div>Genç</div>
                    <div class="legend-item"><div class="legend-dot" style="background:var(--basic)"></div>Temel</div>
                </div>
            </div>
        </aside>

        <!-- Main Area -->
        <main class="main-area">
            <section class="simulation-panel panel">
                <div id="simulationCanvas" class="canvas">
                    <div class="loading">Simülasyon başlatılmayı bekliyor...</div>
                </div>
            </section>

            <section class="stats-panel panel">
                <h2 class="section-title">📊 Canlı İstatistikler</h2>
                <div id="statsContainer">
                    <div class="stat-card"><div class="stat-value" id="bacteriaCountStat">0</div><div class="stat-label">Toplam Bakteri</div></div>
                    <div class="stat-card"><div class="stat-value" id="foodCountStat">0</div><div class="stat-label">Yiyecek Parçacığı</div></div>
                    <div class="stat-card"><div class="stat-value" id="currentGenerationStat">0</div><div class="stat-label">Maks. Jenerasyon</div></div>
                    <div class="stat-card"><div class="stat-value" id="avgFitness">0.00</div><div class="stat-label">Ort. Fitness</div></div>
                    <div class="stat-card"><div class="stat-value" id="avgEnergy">0.0</div><div class="stat-label">Ort. Enerji</div></div>
                    <div class="stat-card"><div class="stat-value" id="geneticDiversityPi">0.000</div><div class="stat-label">Nük. Çeşitlilik (π)</div></div>
                    <div class="stat-card"><div class="stat-value" id="tajimasD">0.00</div><div class="stat-label">Tajima's D</div></div>
                </div>
            </section>
            
            <div class="charts-grid-container panel">
                <h2 class="section-title" style="text-align:center; border-bottom:none; margin-bottom:0;">📈 Detaylı Analiz Grafikleri</h2>
                <div class="charts-grid">
                    <div class="chart-container"><h3 class="chart-title">Popülasyon Sayısı</h3><div id="populationChart" class="plotly-chart-div"></div></div>
                    <div class="chart-container"><h3 class="chart-title">Ortalama Fitness</h3><div id="fitnessChart" class="plotly-chart-div"></div></div>
                    <div class="chart-container"><h3 class="chart-title">Ortalama Enerji</h3><div id="energyChart" class="plotly-chart-div"></div></div>
                    <div class="chart-container"><h3 class="chart-title">Nükleotid Çeşitliliği (π)</h3><div id="diversityPiChart" class="plotly-chart-div"></div></div>
                    <div class="chart-container"><h3 class="chart-title">Tajima's D</h3><div id="tajimasDChart" class="plotly-chart-div"></div></div>
                    <div class="chart-container"><h3 class="chart-title">ATP Seviyesi (Ort.)</h3><div id="atpChart" class="plotly-chart-div"></div></div>
                    <div class="chart-container"><h3 class="chart-title">Sıcaklık Değişimi</h3><div id="temperatureChart" class="plotly-chart-div"></div></div>
                    <div class="chart-container"><h3 class="chart-title">Besin Bulunabilirliği</h3><div id="nutrientAvailabilityChart" class="plotly-chart-div"></div></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Bacterium Details Modal -->
    <div id="bacteriumModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeModalBtn">&times;</span>
            <h3 style="color: var(--accent); margin-bottom: 20px; font-size:20px;">🦠 Bakteri Detayları</h3>
            <div id="bacteriumDetails" style="font-size:14px; max-height: 70vh; overflow-y:auto;">Yükleniyor...</div>
        </div>
    </div>

    <!-- Keyboard Shortcuts -->
    <div class="keyboard-shortcuts">
        <div><strong>Kısayollar:</strong> [Space]: Duraklat/Devam | [S]: Başlat | [Q]: Durdur | [A]: Bakteri Ekle</div>
    </div>

    <script>
        // Global state
        let isRunning = false;
        let isPaused = false;
        let socket = null; // Socket.IO bağlantısı için
        let simDataCache = { // Grafik verilerini biriktirmek için
            time: [], population: [], avg_fitness: [], avg_energy: [],
            diversity_pi: [], tajimas_d: [], avg_atp: [],
            temperature: [], nutrient_availability: []
        };
        const MAX_DATA_POINTS = 100; // Grafiklerde tutulacak maksimum veri noktası

        // API endpoint'leri (Python Flask sunucunuzun adresine göre güncelleyin)
        const API_BASE_URL = ''; // Eğer aynı origin'de ise boş bırakılabilir

        // DOM Elements
        const el = (id) => document.getElementById(id);
        const query = (selector) => document.querySelector(selector);

        // Initialize Socket.IO (opsiyonel, eğer backend socket.io kullanıyorsa)
        function initializeSocketConnection() {
            // socket = io(API_BASE_URL); // Eğer farklı bir domain/port ise belirtin
            // socket.on('connect', () => {
            //     console.log('🔗 Sunucuya Socket.IO ile bağlandı');
            //     updateConnectionStatus(true);
            //     socket.emit('request_initial_data'); // Başlangıç verisi iste
            // });
            // socket.on('disconnect', () => {
            //     console.log('❌ Sunucu Socket.IO bağlantısı kesildi');
            //     updateConnectionStatus(false);
            // });
            // socket.on('simulation_data_update', (data) => { // Backend bu event'i göndermeli
            //     console.log('Socket data received:', data);
            //     processSimulationData(data);
            // });
            // socket.on('simulation_stopped', () => {
            //     isRunning = false; isPaused = false; updateUI(); clearCanvas();
            //     console.log('Sunucudan simülasyon durduruldu bilgisi alındı.');
            // });
             // Şimdilik Socket.IO olmadan REST API polling kullanalım
            console.log("Socket.IO şimdilik devre dışı, REST API polling kullanılacak.");
            updateConnectionStatus(true); // Simüle edilmiş bağlantı durumu
        }


        function updateConnectionStatus(connected) {
            const statusEl = el('connectionStatus');
            if (connected) {
                statusEl.textContent = 'BAĞLI';
                statusEl.className = 'connection-status connected';
            } else {
                statusEl.textContent = 'BAĞLANTI YOK';
                statusEl.className = 'connection-status disconnected';
            }
        }

        // API calls
        async function fetchApi(endpoint, method = 'GET', body = null) {
            try {
                const options = { method };
                if (body) {
                    options.headers = { 'Content-Type': 'application/json' };
                    options.body = JSON.stringify(body);
                }
                const response = await fetch(`${API_BASE_URL}/api${endpoint}`, options);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: response.statusText }));
                    throw new Error(`API Hatası ${response.status}: ${errorData.message || 'Bilinmeyen hata'}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`❌ API çağrısı ${endpoint} başarısız:`, error);
                alert(`API ile iletişimde sorun: ${error.message}`);
                // Bağlantı hatası durumunda UI'ı güncelle
                if (endpoint !== '/simulation_data') { // Sürekli veri çekme hatası için alert gösterme
                     updateConnectionStatus(false);
                }
                throw error; // Hatayı tekrar fırlat ki çağıran fonksiyon da bilsin
            }
        }

        async function startSimulation() {
            const bacteriaCount = parseInt(el('bacteriaCount').value);
            if (isNaN(bacteriaCount) || bacteriaCount <= 0) {
                alert("Lütfen geçerli bir bakteri sayısı girin.");
                return;
            }
            try {
                const result = await fetchApi('/start_simulation', 'POST', { initial_bacteria_count: bacteriaCount });
                if (result.status === 'success' || result.message.includes("başlatıldı")) { // Backend'den gelen yanıta göre
                    isRunning = true; isPaused = false; updateUI();
                    console.log('✅ Simülasyon başlatıldı:', result.message);
                    el('simulationCanvas').innerHTML = '<div class="loading">Simülasyon verileri yükleniyor...</div>';
                } else {
                    console.error('❌ Simülasyon başlatılamadı:', result.message);
                    alert('Simülasyon başlatılamadı: ' + result.message);
                }
            } catch (error) { /* Hata fetchApi içinde zaten loglandı/alertlendi */ }
        }

        async function pauseResumeSimulation() {
            if (!isRunning) return;
            const endpoint = isPaused ? '/resume_simulation' : '/pause_simulation';
            try {
                const result = await fetchApi(endpoint, 'POST');
                 if (result.status === 'success' || result.message) {
                    isPaused = endpoint === '/pause_simulation' ? true : !result.already_running; // Backend'den gelen duruma göre ayarla
                    if (endpoint === '/resume_simulation' && result.message.includes("devam ediyor")) isPaused = false;
                    if (endpoint === '/pause_simulation' && result.message.includes("duraklatıldı")) isPaused = true;

                    updateUI();
                    console.log(`⏯️ Simülasyon ${isPaused ? 'duraklatıldı' : 'devam ettirildi'}. Mesaj: ${result.message}`);
                }
            } catch (error) { /* Hata fetchApi içinde zaten loglandı/alertlendi */ }
        }

        async function stopSimulation() {
            try {
                const result = await fetchApi('/stop_simulation', 'POST');
                if (result.status === 'success' || result.message.includes("durduruldu")) {
                    isRunning = false; isPaused = false; updateUI(); clearCanvasAndData();
                    console.log('⏹️ Simülasyon durduruldu.');
                }
            } catch (error) { /* Hata fetchApi içinde zaten loglandı/alertlendi */ }
        }
        
        async function addBacteria() {
             if (!isRunning) {
                alert("Lütfen önce simülasyonu başlatın.");
                return;
            }
            try {
                const result = await fetchApi('/add_bacteria', 'POST', { count: 10 });
                console.log('➕ Bakteri eklendi:', result.message);
            } catch (error) { /* Hata fetchApi içinde zaten loglandı/alertlendi */ }
        }

        async function exportData() {
            try {
                // Simülasyon çalışıyorsa, güncel veriyi backend'den alıp birleştirebiliriz
                // veya sadece loglanan veriyi alabiliriz. Şimdilik loglanan veriyi alalım.
                const dataToExport = await fetchApi('/get_results'); // Bu endpoint'in backend'de olması lazım

                const blob = new Blob([JSON.stringify(dataToExport, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `neomag_v7_data_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a); // Firefox için gerekli
                a.click();
                document.body.removeChild(a); // Temizle
                URL.revokeObjectURL(url);
                console.log('💾 Veri dışa aktarıldı.');
            } catch (error) { console.error('❌ Veri dışa aktarma hatası:', error); }
        }
        
        function clearCanvasAndData() {
            el('simulationCanvas').innerHTML = '<div class="loading">Simülasyon başlatılmayı bekliyor...</div>';
            // Grafik verilerini sıfırla
            simDataCache = { time: [], population: [], avg_fitness: [], avg_energy: [], diversity_pi: [], tajimas_d: [], avg_atp: [], temperature: [], nutrient_availability: [] };
            // Tüm grafikleri temizle
            const chartIds = ['populationChart', 'fitnessChart', 'energyChart', 'diversityPiChart', 'tajimasDChart', 'atpChart', 'temperatureChart', 'nutrientAvailabilityChart'];
            chartIds.forEach(id => {
                const chartDiv = el(id);
                if (chartDiv) Plotly.purge(chartDiv); // Var olan grafiği temizle
            });
            // İstatistikleri sıfırla
            el('bacteriaCountStat').textContent = '0';
            el('foodCountStat').textContent = '0';
            el('currentGenerationStat').textContent = '0';
            el('avgFitness').textContent = '0.00';
            el('avgEnergy').textContent = '0.0';
            el('geneticDiversityPi').textContent = '0.000';
            el('tajimasD').textContent = '0.00';
            el('stepDisplay').textContent = '0';
        }


        // UI updates
        function updateUI() {
            const statusEl = el('simulationStatus');
            const startBtn = el('startBtn');
            const pauseBtn = el('pauseBtn');
            const stopBtn = el('stopBtn');
            const addBacteriaBtn = el('addBacteriaBtn');

            if (isRunning) {
                statusEl.textContent = isPaused ? 'DURAKLATILDI' : 'ÇALIŞIYOR';
                statusEl.className = `status-pill ${isPaused ? 'status-paused' : 'status-running'}`;
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                pauseBtn.textContent = isPaused ? '▶️ Devam Et' : '⏸️ Duraklat';
                stopBtn.disabled = false;
                addBacteriaBtn.disabled = false;
            } else {
                statusEl.textContent = 'DURDU';
                statusEl.className = 'status-pill status-stopped';
                startBtn.disabled = false;
                pauseBtn.disabled = true;
                pauseBtn.textContent = '⏸️ Duraklat';
                stopBtn.disabled = true;
                addBacteriaBtn.disabled = true;
            }
        }
        
        function processSimulationData(data) {
            if (!data) return;

            el('fpsDisplay').textContent = data.performance?.steps_per_second?.toFixed(1) || '--';
            el('stepDisplay').textContent = data.time_step || data.steps || '0'; // Backend'den gelen doğru alanı kullan

            // Genel istatistikler
            el('bacteriaCountStat').textContent = data.bacteria_count || '0';
            el('foodCountStat').textContent = data.food_count || '0';
            el('currentGenerationStat').textContent = data.current_generation || '0';

            // Ortalama değerler (eğer backend bu şekilde sağlıyorsa)
            // Yoksa, bacteria_sample üzerinden hesaplanabilir.
            if (data.bacteria_sample && data.bacteria_sample.length > 0) {
                const bs = data.bacteria_sample;
                el('avgFitness').textContent = (bs.reduce((sum, b) => sum + (b.current_fitness_calculated || 0), 0) / bs.length).toFixed(2);
                el('avgEnergy').textContent = (bs.reduce((sum, b) => sum + (b.energy_level || 0), 0) / bs.length).toFixed(1);
            } else {
                 el('avgFitness').textContent = '0.00';
                 el('avgEnergy').textContent = '0.0';
            }
            
            // Popülasyon genetiği verileri (bu veriler daha seyrek güncellenebilir)
            // Son loglanan popgen verisini kullanabiliriz.
            if(data.scientific_data_log && data.scientific_data_log.population_genetics && data.scientific_data_log.population_genetics.length > 0){
                const lastPopGen = data.scientific_data_log.population_genetics[data.scientific_data_log.population_genetics.length -1];
                el('geneticDiversityPi').textContent = (lastPopGen.nucleotide_diversity_pi || 0).toFixed(3);
                el('tajimasD').textContent = (lastPopGen.tajimas_d || 0).toFixed(2);
            }


            updateCanvas(data);
            updateAllCharts(data);
        }


        function updateCanvas(data) {
            const canvas = el('simulationCanvas');
            const canvasRect = canvas.getBoundingClientRect(); // Canvas boyutlarını al
            // Canvas'ı temizle (sadece bakteri ve yiyecekleri)
            Array.from(canvas.children).forEach(child => {
                if (child.classList.contains('bacterium') || child.classList.contains('food')) {
                    canvas.removeChild(child);
                } else if (child.classList.contains('loading')) { // Yükleme mesajını da kaldır
                    canvas.removeChild(child);
                }
            });


            if (!data.bacteria_sample || data.bacteria_sample.length === 0) {
                if (!canvas.querySelector('.loading')) { // Eğer yükleme mesajı yoksa ekle
                    const loading = document.createElement('div');
                    loading.className = 'loading';
                    loading.textContent = isRunning ? 'Veri bekleniyor...' : 'Simülasyon başlatılmadı.';
                    canvas.appendChild(loading);
                }
                return;
            }
            
            // Bakteri ve yiyecek pozisyonlarını canvas boyutlarına göre ölçekle
            const worldWidth = data.world_dimensions ? data.world_dimensions[0] : 100; // Backend'den gelmeli
            const worldHeight = data.world_dimensions ? data.world_dimensions[1] : 100;

            data.bacteria_sample.forEach((b, index) => {
                const bacteriumEl = document.createElement('div');
                // Sınıflandırma (örnek: fitness'a göre)
                let bacClass = 'basic';
                const fitness = b.current_fitness_calculated || 0;
                if (fitness > 0.85) bacClass = 'elite';
                else if (fitness > 0.7) bacClass = 'veteran';
                else if (fitness > 0.55) bacClass = 'strong';
                else if (b.energy_level > 70) bacClass = 'energetic';
                else if (b.age < 50) bacClass = 'young';

                bacteriumEl.className = `bacterium ${bacClass}`;
                
                // Pozisyonları ölçekle
                const posX = (b.position[0] / worldWidth) * canvasRect.width;
                const posY = (b.position[1] / worldHeight) * canvasRect.height;

                bacteriumEl.style.left = `${Math.max(0, Math.min(posX, canvasRect.width - (b.size || 5) - 5))}px`;
                bacteriumEl.style.top = `${Math.max(0, Math.min(posY, canvasRect.height - (b.size || 5) - 5))}px`;
                
                const displaySize = Math.max(5, (b.size || 0.5) * 5 + 5); // Boyutu biraz daha görünür yap
                bacteriumEl.style.width = `${displaySize}px`;
                bacteriumEl.style.height = `${displaySize}px`;
                
                bacteriumEl.dataset.id = b.id; // ID'yi data attribute olarak sakla
                bacteriumEl.addEventListener('click', () => showBacteriumDetails(b));
                canvas.appendChild(bacteriumEl);
            });

            if (data.food_sample) {
                data.food_sample.forEach(food => {
                    const foodEl = document.createElement('div');
                    foodEl.className = 'food';
                    const foodPosX = (food.position[0] / worldWidth) * canvasRect.width;
                    const foodPosY = (food.position[1] / worldHeight) * canvasRect.height;
                    
                    foodEl.style.left = `${Math.max(0, Math.min(foodPosX, canvasRect.width - (food.size || 2)))}px`;
                    foodEl.style.top = `${Math.max(0, Math.min(foodPosY, canvasRect.height - (food.size || 2)))}px`;
                    const foodDisplaySize = Math.max(3, (food.size || 0.2) * 10);
                    foodEl.style.width = `${foodDisplaySize}px`;
                    foodEl.style.height = `${foodDisplaySize}px`;
                    canvas.appendChild(foodEl);
                });
            }
        }

        function showBacteriumDetails(bacteriumData) {
            const detailsEl = el('bacteriumDetails');
            if (!bacteriumData) {
                detailsEl.innerHTML = "<p>Detaylar yüklenemedi.</p>";
                el('bacteriumModal').style.display = 'flex';
                return;
            }
            
            let html = `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">`;
            // Temel Bilgiler
            html += `<div><h4 style="color: var(--accent); margin-bottom: 10px;">Temel Bilgiler</h4>
                     <p><strong>ID:</strong> ${bacteriumData.id}</p>
                     <p><strong>Konum (X, Y, Z):</strong> 
                        ${bacteriumData.position ? `${bacteriumData.position[0].toFixed(1)}, ${bacteriumData.position[1].toFixed(1)}, ${bacteriumData.position[2].toFixed(1)}` : 'N/A'}
                     </p>
                     <p><strong>Hız (Vx, Vy, Vz):</strong> 
                        ${bacteriumData.velocity ? `${bacteriumData.velocity[0].toFixed(2)}, ${bacteriumData.velocity[1].toFixed(2)}, ${bacteriumData.velocity[2].toFixed(2)}` : 'N/A'}
                     </p>
                     <p><strong>Enerji Seviyesi:</strong> ${bacteriumData.energy_level?.toFixed(2) || 'N/A'}</p>
                     <p><strong>Yaş:</strong> ${bacteriumData.age?.toFixed(1) || 'N/A'}</p>
                     <p><strong>Jenerasyon:</strong> ${bacteriumData.generation || 'N/A'}</p>
                     <p><strong>Boyut:</strong> ${bacteriumData.size?.toFixed(2) || 'N/A'} µm</p>
                     <p><strong>Kütle:</strong> ${(bacteriumData.mass * 1e15)?.toExponential(2) || 'N/A'} pg</p> <!-- pg cinsinden göstermek için -->
                     </div>`;

            // Genetik Bilgiler
            html += `<div><h4 style="color: var(--accent); margin-bottom: 10px;">Genetik Profil</h4>
                     <p><strong>Hesaplanan Fitness:</strong> ${bacteriumData.current_fitness_calculated?.toFixed(3) || 'N/A'}</p>
                     <p><strong>Genom Uzunluğu:</strong> ${bacteriumData.genome_length || 'N/A'} bp</p>
                     <p><strong>Fitness Landscape Pozisyonu (Örnek):</strong> 
                        ${bacteriumData.genetic_profile?.fitness_landscape_position ? 
                            `(${bacteriumData.genetic_profile.fitness_landscape_position.slice(0,3).map(f => f.toFixed(2)).join(', ')}...)` 
                            : 'N/A'}
                     </p>
                     <p><strong>ATP Seviyesi:</strong> ${bacteriumData.atp_level?.toFixed(2) || 'N/A'} mM</p>
                     </div>`;
            
            // Etkileşimler
            html += `<div><h4 style="color: var(--accent); margin-bottom: 10px;">Etkileşimler & Kararlar</h4>
                     <p><strong>MD Etkileşimleri:</strong> ${bacteriumData.md_interactions || 0}</p>
                     <p><strong>Genetik Operasyonlar:</strong> ${bacteriumData.genetic_operations || 0}</p>
                     <p><strong>AI Kararları:</strong> ${bacteriumData.ai_decisions || 0}</p>
                     </div>`;

            html += `</div>`;
            detailsEl.innerHTML = html;
            el('bacteriumModal').style.display = 'flex';
        }
        
        function updateAllCharts(data) {
            if (!data || !isRunning) return; // Simülasyon çalışmıyorsa veya veri yoksa güncelleme

            const currentTime = data.sim_time || data.total_time || (simDataCache.time.length > 0 ? simDataCache.time[simDataCache.time.length - 1] + 1 : 0);

            // Veri biriktirme
            simDataCache.time.push(currentTime);
            simDataCache.population.push(data.bacteria_count || 0);
            
            let avgFit = 0, avgEn = 0, avgAtpVal = 0;
            if (data.bacteria_sample && data.bacteria_sample.length > 0) {
                const bs = data.bacteria_sample;
                avgFit = (bs.reduce((sum, b) => sum + (b.current_fitness_calculated || 0), 0) / bs.length);
                avgEn = (bs.reduce((sum, b) => sum + (b.energy_level || 0), 0) / bs.length);
                avgAtpVal = (bs.reduce((sum,b) => sum + (b.atp_level || 0), 0) / bs.length);
            }
            simDataCache.avg_fitness.push(avgFit);
            simDataCache.avg_energy.push(avgEn);
            simDataCache.avg_atp.push(avgAtpVal);

            // PopGen verileri daha seyrek gelebilir, sonuncuyu kullan
            let currentPi = simDataCache.diversity_pi.length > 0 ? simDataCache.diversity_pi[simDataCache.diversity_pi.length-1] : 0;
            let currentTajD = simDataCache.tajimas_d.length > 0 ? simDataCache.tajimas_d[simDataCache.tajimas_d.length-1] : 0;

            if(data.scientific_data_log && data.scientific_data_log.population_genetics && data.scientific_data_log.population_genetics.length > 0){
                const lastPopGen = data.scientific_data_log.population_genetics[data.scientific_data_log.population_genetics.length -1];
                if(lastPopGen.sim_time >= (simDataCache.time.length > 1 ? simDataCache.time[simDataCache.time.length-2] : 0) ) { // Sadece yeni veri ise
                    currentPi = lastPopGen.nucleotide_diversity_pi || 0;
                    currentTajD = lastPopGen.tajimas_d || 0;
                }
            }
            simDataCache.diversity_pi.push(currentPi);
            simDataCache.tajimas_d.push(currentTajD);
            
            simDataCache.temperature.push(data.environmental_pressures?.temperature || 0);
            simDataCache.nutrient_availability.push(data.environmental_pressures?.nutrient_availability || 0);


            // Maksimum veri noktası kontrolü
            for (const key in simDataCache) {
                if (simDataCache[key].length > MAX_DATA_POINTS) {
                    simDataCache[key].splice(0, simDataCache[key].length - MAX_DATA_POINTS);
                }
            }
            
            // Plotly grafiklerini güncelle
            const chartLayout = (yaxisTitle = '') => ({
                margin: { t: 5, r: 10, b: 25, l: 35 }, paper_bgcolor: 'transparent', plot_bgcolor: 'rgba(255,255,255,0.03)',
                font: { color: 'var(--text2)', size: 10 }, xaxis: { showgrid: false, zeroline: false },
                yaxis: { title: {text: yaxisTitle, font: {size:10}}, showgrid: true, gridcolor: 'rgba(var(--rgb-text3),0.1)', zeroline: false }
            });
            const lineStyle = (color) => ({ color: color, width: 2 });

            try {
                Plotly.react('populationChart', [{ x: simDataCache.time, y: simDataCache.population, type: 'scatter', mode: 'lines', line: lineStyle('var(--success)') }], chartLayout('Sayı'));
                Plotly.react('fitnessChart', [{ x: simDataCache.time, y: simDataCache.avg_fitness, type: 'scatter', mode: 'lines', line: lineStyle('var(--primary)') }], chartLayout('Fitness'));
                Plotly.react('energyChart', [{ x: simDataCache.time, y: simDataCache.avg_energy, type: 'scatter', mode: 'lines', line: lineStyle('var(--energetic)') }], chartLayout('Enerji'));
                Plotly.react('diversityPiChart', [{ x: simDataCache.time, y: simDataCache.diversity_pi, type: 'scatter', mode: 'lines', line: lineStyle('var(--secondary)') }], chartLayout('Pi (π)'));
                Plotly.react('tajimasDChart', [{ x: simDataCache.time, y: simDataCache.tajimas_d, type: 'scatter', mode: 'lines', line: lineStyle('var(--veteran)') }], chartLayout("Tajima's D"));
                Plotly.react('atpChart', [{ x: simDataCache.time, y: simDataCache.avg_atp, type: 'scatter', mode: 'lines', line: lineStyle('var(--young)') }], chartLayout('ATP (mM)'));
                Plotly.react('temperatureChart', [{ x: simDataCache.time, y: simDataCache.temperature, type: 'scatter', mode: 'lines', line: lineStyle('var(--warning)') }], chartLayout('Sıcaklık (K)'));
                Plotly.react('nutrientAvailabilityChart', [{ x: simDataCache.time, y: simDataCache.nutrient_availability, type: 'scatter', mode: 'lines', line: lineStyle('var(--strong)') }], chartLayout('Besin (%)'));
            } catch(e) {
                console.error("Grafik güncelleme hatası:", e);
            }
        }


        // Real-time data fetching (REST API Polling)
        let dataFetchInterval;
        function startDataPolling() {
            if (dataFetchInterval) clearInterval(dataFetchInterval); // Önceki interval'i temizle
            dataFetchInterval = setInterval(async () => {
                if (isRunning && !isPaused) { // Sadece çalışıyorsa ve duraklatılmamışsa veri çek
                    try {
                        const data = await fetchApi('/simulation_data'); // Bu endpoint backend'de olmalı
                        processSimulationData(data);
                    } catch (error) {
                        // Hata zaten fetchApi içinde loglandı.
                        // Belki burada bağlantı kesildi gibi bir durum yönetilebilir.
                        // updateConnectionStatus(false); // Eğer sürekli hata alıyorsak
                    }
                }
            }, 750); // Veri çekme sıklığı (ms)
        }
        

        // Event listeners
        el('startBtn').addEventListener('click', startSimulation);
        el('pauseBtn').addEventListener('click', pauseResumeSimulation);
        el('stopBtn').addEventListener('click', stopSimulation);
        el('addBacteriaBtn').addEventListener('click', addBacteria);
        el('exportBtn').addEventListener('click', exportData);

        // Modal controls
        el('closeModalBtn').addEventListener('click', () => { el('bacteriumModal').style.display = 'none'; });
        window.addEventListener('click', (event) => {
            if (event.target === el('bacteriumModal')) { el('bacteriumModal').style.display = 'none';}
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (document.activeElement.tagName === 'INPUT') return; // Input alanlarındayken kısayolları devre dışı bırak
            switch(e.code) {
                case 'Space': e.preventDefault(); pauseResumeSimulation(); break;
                case 'KeyS': if(!isRunning) startSimulation(); break;
                case 'KeyQ': if(isRunning) stopSimulation(); break;
                case 'KeyA': if(isRunning) addBacteria(); break;
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initializeSocketConnection(); // Socket.IO veya polling için
            updateUI();
            startDataPolling(); // REST API polling'i başlat
            console.log('🚀 NeoMag V7 Web Arayüzü Yüklendi (v2)');
        });
    </script>
</body>
</html>
